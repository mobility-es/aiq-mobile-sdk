#!/usr/bin/env node

'use strict';

var pkg = require('../package.json'),

    Table = require('cli-table'),
    moment = require('moment'),

    program = require('commander'),
    path = require('path'),

    utils = require('../lib/utils'),
    services = new (require('../lib/services'))(path.join(utils.getUserHome(), '.aiqrc'), process.cwd());

process.title = pkg.name;

function processArguments (proxyTo, successCallbackOrText) {
    return function () {
        var args = arguments,
            authInfo = args[args.length - 1].parent;

        function handle () {
            proxyTo.apply(services, args).then(
                function () {
                    if (typeof successCallbackOrText === 'function') {
                        successCallbackOrText.apply(null, arguments);
                    } else {
                        utils.info.call(null, successCallbackOrText);
                    }
                },
                utils.error
            );
        }

        // New Auth info provided
        if (authInfo.orgName && authInfo.username) {
            services.requestToken(authInfo).then(handle, utils.error);
        } else {
            handle();
        }
    };
}

program
    .version(pkg.version)
    .option('-o, --orgName <orgName>', 'organization')
    .option('-u, --username <username>', 'Username')
    .option('-p, --password <password>', 'Password')
    .option('-s, --serverUrl [serverUrl]', 'IA Server URL [serverUrl]', pkg.defaults.server);

program
    .command('login')
    .usage('-o <orgName> -u <username> -p <password>')
    .description('Login to the IA')
    .on('--help', function () {
        this.parent.options.forEach(function (option) {
            if (option.required !== 0 || option.optional !== 0) {
                console.log('    ' + option.flags + '\t' + option.description);
            }
        });
    })
    .action(function () {
        //HACK: in case of wrong call eg. "login -o org -p password -us ername"
        // "arguments" object will contain more that 1 element,
        // i.e. it is not safe to retrieve "params" object as regular func parameter
        var params = arguments[arguments.length - 1].parent;

        // Check existence of required options
        params.options.forEach(function (param) {
            var argName = param.long.replace('--', '');
            if (param.required && !params[argName]) {
                console.error('\n  error: missing required option `%s\'\n', param.long);
                process.exit(1);
            }
        });
        services.login(params).then(function () {
            utils.info('AccessToken successfully stored for the future calls.');
        }, utils.error);
    });

program
    .command('logout')
    .description('Destroy AccessToken.')
    .action(processArguments(services.logout, 'AccessToken successfully removed.'));

program
    .command('list')
    .description('Display list of existent HTML5 Applications')
    .action(processArguments(services.getAppsList, function (result) {
        if (!result.length) {
            utils.info('There are no applications in the platform yet.');
            return;
        }

        var table = new Table({
            head: ['ID', 'Rev', 'Name', 'Modified on', 'API', 'Mock?', 'Global?']
        });

        // Apply Name-based sorting
        result.sort(function (a, b) {
            return a.name.localeCompare(b.name);
        });

        result.forEach(function (app) {
            table.push([
                app._id,
                app._rev,
                app.name,
                app.lastModified ? moment(app.lastModified).fromNow() : 'N/A',
                app.minJsApiLevel || 0,
                app.mock ? 'Yes'.warn : 'No'.info,
                app.global ? 'Yes'.warn : 'No'.info
            ]);
        });
        console.log(table.toString());
    }));

program
    .command('pub [<path>]')
    .description('Publish HTML5 App to the platform')
    .option('-n, --name <App name>', 'Name of the application')
    .option('-l, --apiLevel <api level>', 'API level')
    .option('-m, --mock', 'is in the mock mode?')
    .option('-g, --global', 'is global?')
    .action(processArguments(services.registerApp, function (appInfo) {
        utils.info('New App [%s] with ID: %s was successfully created.', appInfo.name, appInfo.id);
    }));

program
    .command('update [<path>]')
    .description('Update existent HTML5 App')
    .option('-m, --mock', 'is in the mock mode?')
    .option('-g, --global', 'is global?')
    .action(processArguments(services.updateApp, function (appInfo) {
        utils.info('App [%s] with ID: %s was successfully updated.', appInfo.name, appInfo.id);
    }));

program
    .command('unpub [<path>]')
    .description('Remove specific HTML5 App from the platform')
    .option('-i, --id <application id>', 'The application id. If not specified, will be read from the manifest file.')
    .action(processArguments(services.deleteApp, function (appInfo) {
        utils.info('App with ID: %s was successfully removed from the platform.', appInfo.id);
    }));

program
    .command('server [<path>]')
    .description('Run local WebServer')
    .option('-n, --port <port number>', 'Port number', 8000)
    .action(function (path, params) {
        services.server(params.port, path)
            .then(function () {
                utils.info('WebServer successfully started at http://localhost:%d/\nPress <CTRL> + <C> to shutdown.', params.port);
            }, utils.error);
    });

program.parse(process.argv);

if (!program.args.length) {
    program.help();
}
